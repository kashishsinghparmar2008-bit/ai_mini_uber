<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Mini Uber</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    body { font-family: "Segoe UI", sans-serif; background:#f5f5f5; }
    body.dark { background:#0f172a; color:#e5e7eb; }

    .app { max-width:420px; margin:auto; background:white; min-height:100vh; display:flex; flex-direction:column; }
    body.dark .app { background:#1e293b; }

    .header { background:black; color:white; padding:14px; text-align:center; position:relative; }
    .header h2 { font-size:20px; }
    .header small { opacity:0.8; }

    .top-btn { position:absolute; top:10px; padding:4px 10px; border-radius:20px; font-size:12px; cursor:pointer; background:white; color:black; }
    .demo-btn { left:10px; background:#bbf7d0; }
    .admin-btn { right:200px; background:#fde68a; }
    .profile-btn { right:150px; }
    .logout-btn { right:100px; background:#fecaca; }
    .toggle { right:50px; }

    #map { height:280px; width:100%; }

    .sheet { background:white; padding:14px; border-top-left-radius:20px; border-top-right-radius:20px; margin-top:-20px; flex:1; overflow-y:auto; transition:0.3s; }
    body.dark .sheet { background:#1e293b; }

    .card { background:#f3f4f6; padding:10px; border-radius:12px; margin-bottom:10px; font-size:13px; }
    body.dark .card { background:#334155; }

    .banner { background:#e0f2fe; color:#075985; padding:8px; border-radius:8px; margin-bottom:8px; font-size:13px; }
    .offline { background:#fee2e2; color:#991b1b; }

    .row { display:flex; justify-content:space-between; margin:4px 0; }

    .badge { background:#fee2e2; color:#991b1b; padding:2px 8px; border-radius:20px; font-size:12px; }
    .surge { background:#dc2626; color:white; padding:2px 8px; border-radius:20px; font-size:12px; }

    .bar { height:8px; background:#e5e7eb; border-radius:10px; overflow:hidden; margin-top:4px; }
    .fill { height:100%; background:#22c55e; width:80%; }

    button { width:100%; padding:12px; background:black; color:white; border:none; border-radius:10px; margin-top:10px; cursor:pointer; font-size:16px; }

    .status { text-align:center; font-size:13px; margin-top:6px; color:#2563eb; }
    .admin-panel { display:none; background:#fef3c7; }

    .toast { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:black; color:white; padding:10px 16px; border-radius:20px; font-size:13px; opacity:0; transition:0.3s; }
    .toast.show { opacity:1; }

    .modal {
      position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.5);
      display:none; align-items:center; justify-content:center;
      z-index:10;
    }

    .modal-box {
      background:white; padding:20px; border-radius:12px; width:300px;
    }

    body.dark .modal-box { background:#1e293b; color:white; }

    .footer { text-align:center; font-size:12px; padding:10px; color:#888; }
  </style>
</head>

<body>

<script>
  if (localStorage.getItem("loggedIn") !== "true") {
    window.location.href = "login.html";
  }
</script>

<div class="app">

  <div class="header">
    <div class="top-btn demo-btn" onclick="demoMode()">Demo</div>
    <div class="top-btn admin-btn" onclick="toggleAdmin()">Admin</div>
    <div class="top-btn profile-btn" onclick="openProfile()">ğŸ‘¤</div>
    <div class="top-btn logout-btn" onclick="logout()">â‹</div>
    <div class="top-btn toggle" onclick="toggleDark()">ğŸŒ™</div>
    <h2>AI Mini Uber</h2>
    <small id="welcomeUser"></small>
  </div>

  <div id="map"></div>

  <div class="sheet" id="sheet">

    <div class="banner" id="predictionBanner">ğŸ”® AI Prediction: High demand expected in Area B in next 30 minutes</div>
    <div class="banner offline" id="offlineBanner" style="display:none;">âš ï¸ You are offline. Showing cached data.</div>

    <div class="card">
      ğŸŒ Network: 4G | Low Latency<br>
      Total Rides: <b id="totalRides">0</b> | Avg Fare: â‚¹ <b id="avgFare">0</b>
    </div>

    <div class="card">
      <div class="row"><span>Pickup:</span><span id="pickupText">Tap on map</span></div>
      <div class="row"><span>Drop:</span><span id="dropText">Tap on map</span></div>
      <div class="row"><span>Distance:</span><span id="distanceText">â€“ km</span></div>
      <div class="row"><span>Fare:</span><span id="fareText">â‚¹ â€“</span></div>
      <div class="row"><span>High Demand:</span><span class="badge" id="demandText">â€“</span></div>
      <div class="row"><span>Surge:</span><span id="surgeText">â€“</span></div>
    </div>

    <div class="card" id="driverCard">
      <b>Driver:</b> Rahul Sharma<br>
      â­ Rating: 4.9<br>
      ğŸš— Vehicle: DL 01 AB 1234<br>
      ğŸ“ <span style="color:blue;cursor:pointer" onclick="callDriver()">Call Driver</span><br>
      AI Score: <b id="aiScore">â€“</b>
    </div>

    <div class="card" id="aiBox">ğŸ¤– AI reasoning will appear here.</div>

    <div class="card" id="aiTimeline">
      ğŸ¤– AI Timeline:
      <div id="timelineSteps">â€¢ Waiting for action...</div>
    </div>

    <div class="card">ğŸš— Driver ETA: <b id="etaText">â€“</b> min</div>

    <div class="card">
      AI Confidence:
      <div class="bar"><div class="fill" id="confidenceFill"></div></div>
    </div>

    <div class="card" id="historyBox">
      <b>Ride History:</b>
      <div id="historyList">No rides yet</div>
    </div>

    <div class="card">
      <b>Why AI?</b><br>
      â€¢ Predicts demand<br>
      â€¢ Optimizes driver selection<br>
      â€¢ Learns pricing patterns
    </div>

    <div class="card admin-panel" id="adminPanel">
      <b>ğŸ›  Admin Panel</b><br>
      Active Drivers: 3<br>
      High Demand Zone: <span id="adminDemand">â€“</span><br>
      Total Rides Today: <span id="adminRides">0</span>
    </div>

    <button onclick="bookRide()">Book Ride</button>
    <div class="status" id="statusText"></div>

  </div>

  <div class="footer">Built by Kashish â€¢ AI + DSA Project</div>
</div>

<!-- Payment Modal -->
<div class="modal" id="paymentModal">
  <div class="modal-box">
    <h3>ğŸ’³ Choose Payment</h3>
    <button onclick="pay('Cash')">Cash</button>
    <button onclick="pay('UPI')">UPI</button>
    <button onclick="pay('Card')">Card</button>
  </div>
</div>

<!-- Rating Modal -->
<div class="modal" id="ratingModal">
  <div class="modal-box">
    <h3>â­ Rate Your Ride</h3>
    <button onclick="rate(5)">â˜…â˜…â˜…â˜…â˜…</button>
    <button onclick="rate(4)">â˜…â˜…â˜…â˜…â˜†</button>
    <button onclick="rate(3)">â˜…â˜…â˜…â˜†â˜†</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  let map, carMarker, pickupMarker, dropMarker, pickupLatLng, dropLatLng;
  let totalRides = 0, totalFare = 0;
  let history = [];
  let adminOn = false;

  document.getElementById("welcomeUser").innerText = "Welcome, " + localStorage.getItem("username");

  function toggleDark() { document.body.classList.toggle("dark"); }

  function toggleAdmin() {
    adminOn = !adminOn;
    document.getElementById("adminPanel").style.display = adminOn ? "block" : "none";
  }

  function logout() {
    localStorage.removeItem("loggedIn");
    localStorage.removeItem("username");
    window.location.href = "login.html";
  }

  function openProfile() {
    alert("ğŸ‘¤ User: " + localStorage.getItem("username") + "\nâ­ Rating: 4.9\nğŸš• Rides: " + totalRides);
  }

  function callDriver() {
    alert("ğŸ“ Calling driver...");
  }

  function showToast(msg) {
    const toast = document.getElementById("toast");
    toast.innerText = msg;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 2500);
  }

  function demoMode() {
    bookRide();
  }

  function initMap() {
    map = L.map("map").setView([28.6139, 77.2090], 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    map.on("click", function(e) {
      if(!pickupLatLng) {
        pickupLatLng = e.latlng;
        pickupMarker = L.marker(pickupLatLng).addTo(map).bindPopup("ğŸ“ Pickup").openPopup();
        pickupText.innerText = pickupLatLng.lat.toFixed(3) + ", " + pickupLatLng.lng.toFixed(3);
      } else if(!dropLatLng) {
        dropLatLng = e.latlng;
        dropMarker = L.marker(dropLatLng).addTo(map).bindPopup("ğŸ Drop").openPopup();
        dropText.innerText = dropLatLng.lat.toFixed(3) + ", " + dropLatLng.lng.toFixed(3);
        L.polyline([pickupLatLng, dropLatLng], { color:"#2563eb", weight:4 }).addTo(map);
        carMarker = L.marker(pickupLatLng).addTo(map).bindPopup("ğŸš— Driver");
      }
    });
  }

  initMap();

  function animateCar() {
    if(!pickupLatLng || !dropLatLng) return;
    let latStep = (dropLatLng.lat - pickupLatLng.lat) / 20;
    let lngStep = (dropLatLng.lng - pickupLatLng.lng) / 20;
    let i = 0;

    const interval = setInterval(() => {
      if(i >= 20) { clearInterval(interval); return; }
      let lat = pickupLatLng.lat + latStep * i;
      let lng = pickupLatLng.lng + lngStep * i;
      carMarker.setLatLng([lat, lng]);
      i++;
    }, 500);
  }

  function bookRide() {
    if(!pickupLatLng || !dropLatLng) {
      alert("Please select pickup and drop on map");
      return;
    }
    statusText.innerText = "Choose payment method...";
    document.getElementById("paymentModal").style.display = "flex";
  }

  function pay(method) {
    document.getElementById("paymentModal").style.display = "none";
    showToast("Paid using " + method);
    startRide();
  }

  function startRide() {
    statusText.innerText = "Driver assigned. On the way...";
    timelineSteps.innerHTML = "â€¢ AI analyzing demand...";
    setTimeout(()=>timelineSteps.innerHTML+="<br>â€¢ Optimizing route...",800);
    setTimeout(()=>timelineSteps.innerHTML+="<br>â€¢ Driver selected...",1600);
    setTimeout(()=>timelineSteps.innerHTML+="<br>â€¢ Ride started âœ…",2400);

    let fare = Math.floor(Math.random()*100)+100;
    fareText.innerText = "â‚¹ " + fare;
    distanceText.innerText = (Math.random()*5+1).toFixed(2) + " km";
    demandText.innerText = "High";
    surgeText.innerHTML = '<span class="surge">Surge Active ğŸ”º</span>';

    aiBox.innerHTML = "ğŸ¤– AI Reasoning:<br>â€¢ High demand area<br>â€¢ Closest driver selected<br>â€¢ Optimal pricing applied";

    etaText.innerText = Math.floor(Math.random()*5)+2;
    confidenceFill.style.width = (Math.floor(Math.random()*20)+70) + "%";

    animateCar();

    totalRides++;
    totalFare += fare;
    totalRidesElem.innerText = totalRides;
    avgFareElem.innerText = Math.round(totalFare / totalRides);

    history.unshift("Ride completed | â‚¹" + fare);
    historyList.innerHTML = history.map(h=>"â€¢ "+h).join("<br>");

    adminDemand.innerText = "High";
    adminRides.innerText = totalRides;

    setTimeout(()=> {
      statusText.innerText = "Ride completed âœ”ï¸";
      document.getElementById("ratingModal").style.display = "flex";
    }, 12000);
  }

  function rate(stars) {
    document.getElementById("ratingModal").style.display = "none";
    showToast("Thanks for rating " + stars + " stars â­");
  }
</script>

</body>
</html>

