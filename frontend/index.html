<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Mini Uber ‚Äì Ultimate Edition</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: "Segoe UI", Tahoma, sans-serif;
      background: #f1f3f6;
      transition: 0.3s;
    }

    body.dark { background: #0f172a; color: #e5e7eb; }
    body.accessible { font-size: 18px; }

    /* LOGIN */
    .login-screen {
      max-width: 360px;
      margin: 70px auto;
      background: white;
      padding: 22px;
      border-radius: 14px;
      text-align: center;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      animation: fadeIn 0.6s ease;
    }
    body.dark .login-screen { background: #1e293b; }

    .login-screen input {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .login-screen button {
      width: 100%;
      padding: 10px;
      background: black;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    /* APP */
    .app-container {
      max-width: 430px;
      margin: 20px auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      overflow: hidden;
      animation: fadeIn 0.6s ease;
    }
    body.dark .app-container { background: #1e293b; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .header {
      background: linear-gradient(135deg, #000, #333);
      color: white;
      padding: 16px;
      text-align: center;
      position: relative;
    }

    .header small { opacity: 0.8; }

    .toggle, .acc-toggle, .demo-btn, .admin-btn {
      position: absolute;
      top: 10px;
      background: white;
      color: black;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      cursor: pointer;
    }

    .toggle { right: 10px; }
    .acc-toggle { right: 60px; }
    .admin-btn { right: 120px; background: #fde68a; }
    .demo-btn { left: 10px; background: #bbf7d0; }

    #map { height: 260px; width: 100%; }

    .content { padding: 14px; }

    .banner {
      background: #e0f2fe;
      color: #075985;
      padding: 8px;
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 8px;
    }

    .offline {
      background: #fee2e2;
      color: #991b1b;
    }

    .network { font-size: 12px; color: #16a34a; margin-bottom: 6px; }

    .dashboard {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-bottom: 8px;
      color: #444;
    }

    .row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
      font-size: 14px;
    }

    .badge {
      background: #fee2e2;
      color: #991b1b;
      padding: 3px 8px;
      border-radius: 20px;
      font-size: 12px;
    }

    .surge {
      background: #dc2626;
      color: white;
      padding: 3px 8px;
      border-radius: 20px;
      font-size: 12px;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .driver-card {
      margin-top: 10px;
      padding: 10px;
      background: #f3f4f6;
      border-radius: 10px;
      font-size: 13px;
    }
    body.dark .driver-card { background: #334155; }

    .ai-box {
      margin-top: 10px;
      padding: 10px;
      background: #e0e7ff;
      border-radius: 10px;
      font-size: 13px;
      color: #1e3a8a;
    }
    body.dark .ai-box { background: #1e40af; color: #e0e7ff; }

    .ai-timeline {
      background: #eff6ff;
      padding: 8px;
      border-radius: 8px;
      font-size: 13px;
      margin-top: 10px;
      color: #2563eb;
    }
    body.dark .ai-timeline { background: #1e3a8a; color: #e0e7ff; }

    .history {
      margin-top: 10px;
      padding: 10px;
      background: #f9fafb;
      border-radius: 10px;
      font-size: 12px;
    }
    body.dark .history { background: #334155; }

    .confidence {
      margin-top: 10px;
      font-size: 12px;
    }

    .bar {
      height: 8px;
      background: #e5e7eb;
      border-radius: 10px;
      overflow: hidden;
      margin-top: 4px;
    }

    .fill {
      height: 100%;
      width: 80%;
      background: #22c55e;
    }

    .why-ai {
      margin-top: 10px;
      padding: 10px;
      background: #ecfeff;
      border-radius: 10px;
      font-size: 12px;
      color: #0f766e;
    }

    .admin-panel {
      margin-top: 10px;
      padding: 10px;
      background: #fef3c7;
      border-radius: 10px;
      font-size: 13px;
      display: none;
    }

    button {
      width: 100%;
      padding: 12px;
      margin-top: 10px;
      background: black;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: 0.3s;
    }

    button:hover {
      background: #333;
      transform: scale(1.03);
    }

    .status {
      text-align: center;
      font-size: 13px;
      margin-top: 8px;
      color: #2563eb;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: black;
      color: white;
      padding: 10px 16px;
      border-radius: 20px;
      font-size: 13px;
      opacity: 0;
      transition: 0.3s;
    }
    .toast.show { opacity: 1; }

    .footer {
      text-align: center;
      padding: 10px;
      font-size: 12px;
      color: #888;
      background: #fafafa;
    }
    body.dark .footer { background: #1e293b; color: #94a3b8; }

    @media(max-width:480px) {
      .app-container { margin: 10px; }
    }
  </style>
</head>

<body>

<!-- LOGIN -->
<div class="login-screen" id="loginScreen">
  <h2>üîê Login</h2>
  <input type="text" id="username" placeholder="Username" />
  <input type="password" id="password" placeholder="Password" />
  <button onclick="login()">Login</button>
  <div id="loginMsg"></div>
</div>

<!-- APP -->
<div class="app-container" id="appContainer" style="display:none;">
  <div class="header">
    <div class="demo-btn" onclick="demoMode()">üé¨ Demo</div>
    <div class="admin-btn" onclick="toggleAdmin()">üõ† Admin</div>
    <div class="acc-toggle" onclick="toggleAccessibility()">‚ôø</div>
    <div class="toggle" onclick="toggleDark()">üåô</div>
    <h2>AI Mini Uber</h2>
    <small>AI that moves you</small>
  </div>

  <div id="map"></div>

  <div class="content">
    <div class="banner" id="predictionBanner">üîÆ AI Prediction: High demand expected in Area B in next 30 minutes</div>
    <div class="banner offline" id="offlineBanner" style="display:none;">‚ö†Ô∏è You are offline. Showing cached data.</div>
    <div class="network">üåê Network: 4G | Low Latency</div>

    <div class="dashboard">
      <span>Total Rides: <b id="totalRides">0</b></span>
      <span>Avg Fare: ‚Çπ <b id="avgFare">0</b></span>
    </div>

    <div class="row"><span>Pickup:</span><span id="pickupText">A</span></div>
    <div class="row"><span>Drop:</span><span id="dropText">D</span></div>
    <div class="row"><span>Distance:</span><span id="distanceText">‚Äì km</span></div>
    <div class="row"><span>Fare:</span><span id="fareText">‚Çπ ‚Äì</span></div>
    <div class="row"><span>High Demand:</span><span class="badge" id="demandText">‚Äì</span></div>
    <div class="row"><span>Surge:</span><span id="surgeText">‚Äì</span></div>

    <!-- Driver Card -->
    <div class="driver-card" id="driverCard">
      <b>Driver:</b> ‚Äì <br>
      ‚≠ê Rating: 4.8 <br>
      üöó Vehicle: DL 01 AB 1234 <br>
      AI Score: <b id="aiScore">‚Äì</b>
    </div>

    <!-- Explainable AI -->
    <div class="ai-box" id="aiBox">ü§ñ AI reasoning will appear here.</div>

    <!-- AI Timeline -->
    <div class="ai-timeline" id="aiTimeline">
      ü§ñ AI Timeline:
      <div id="timelineSteps">‚Ä¢ Waiting for action...</div>
    </div>

    <!-- Driver ETA -->
    <div style="margin-top:8px; font-size:13px;">
      üöó Driver ETA: <b id="etaText">‚Äì</b> min
    </div>

    <!-- AI Confidence -->
    <div class="confidence">
      AI Confidence:
      <div class="bar"><div class="fill" id="confidenceFill"></div></div>
    </div>

    <!-- Ride History -->
    <div class="history" id="historyBox">
      <b>Ride History:</b>
      <div id="historyList">No rides yet</div>
    </div>

    <!-- Why AI -->
    <div class="why-ai">
      <b>Why AI?</b><br>
      ‚Ä¢ Predicts demand<br>
      ‚Ä¢ Optimizes driver selection<br>
      ‚Ä¢ Learns pricing patterns
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
      <b>üõ† Admin Panel</b><br>
      Active Drivers: 3<br>
      High Demand Zone: <span id="adminDemand">‚Äì</span><br>
      Total Rides Today: <span id="adminRides">0</span>
    </div>

    <button onclick="bookRide()">Book Ride</button>
    <div class="status" id="statusText"></div>
  </div>

  <div class="footer">
    Built by Kashish ‚Ä¢ AI + DSA Project
  </div>
</div>

<div class="toast" id="toast"></div>

<!-- Sounds -->
<audio id="clickSound" src="https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3"></audio>
<audio id="notifySound" src="https://assets.mixkit.co/sfx/preview/mixkit-bell-notification-933.mp3"></audio>

<script>
  let map, carMarker;
  let totalRides = 0, totalFare = 0;
  let history = [];
  let adminOn = false;

  function toggleDark() {
    document.body.classList.toggle("dark");
  }

  function toggleAccessibility() {
    document.body.classList.toggle("accessible");
  }

  function toggleAdmin() {
    adminOn = !adminOn;
    document.getElementById("adminPanel").style.display = adminOn ? "block" : "none";
  }

  function showToast(msg) {
    const toast = document.getElementById("toast");
    toast.innerText = msg;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 2500);
  }

  async function login() {
    const u = username.value;
    const p = password.value;

    try {
      const res = await fetch(`https://ai-mini-uber.onrender.com/login?username=${u}&password=${p}`);
      const data = await res.json();

      if (data.success) {
        loginScreen.style.display = "none";
        appContainer.style.display = "block";
        initMap();
        showToast("Login successful!");
      } else {
        loginMsg.innerText = "Invalid login!";
      }
    } catch {
      offlineBanner.style.display = "block";
    }
  }

  function demoMode() {
    username.value = "user1";
    password.value = "1234";
    login();
    setTimeout(() => bookRide(), 1500);
  }

  function initMap() {
    map = L.map("map").setView([28.6139, 77.2090], 13);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "¬© OpenStreetMap"
    }).addTo(map);

    const pickup = [28.6139, 77.2090];
    const drop = [28.6200, 77.2300];

    L.marker(pickup).addTo(map).bindPopup("üìç Pickup");
    L.marker(drop).addTo(map).bindPopup("üèÅ Drop");

    L.polyline([pickup, drop], { color: "#2563eb", weight: 4 }).addTo(map);

    carMarker = L.marker(pickup).addTo(map).bindPopup("üöó Driver");

    loadHeatmap();
  }

  function animateCar() {
    const path = [
      [28.6139, 77.2090],
      [28.6160, 77.2150],
      [28.6180, 77.2220],
      [28.6200, 77.2300]
    ];

    let i = 0;
    const interval = setInterval(() => {
      if (i >= path.length) {
        clearInterval(interval);
        return;
      }
      carMarker.setLatLng(path[i]);
      i++;
    }, 800);
  }

  async function bookRide() {
    document.getElementById("clickSound").play();
    statusText.innerText = "Searching for driver...";

    const timeline = document.getElementById("timelineSteps");
    timeline.innerHTML = "‚Ä¢ Analyzing drivers...";
    setTimeout(() => timeline.innerHTML += "<br>‚Ä¢ Checking traffic & demand...", 600);
    setTimeout(() => timeline.innerHTML += "<br>‚Ä¢ Calculating optimal fare...", 1200);
    setTimeout(() => timeline.innerHTML += "<br>‚Ä¢ Optimizing route...", 1800);
    setTimeout(() => timeline.innerHTML += "<br>‚Ä¢ Decision locked ‚úÖ", 2400);

    setTimeout(() => statusText.innerText = "Driver assigned...", 800);
    setTimeout(() => statusText.innerText = "On the way...", 1500);

    try {
      const res = await fetch("https://ai-mini-uber.onrender.com/ride");
      const data = await res.json();

      pickupText.innerText = data.pickup;
      dropText.innerText = data.drop;
      distanceText.innerText = data.rideDistance + " km";
      fareText.innerText = "‚Çπ " + data.fare;
      demandText.innerText = data.highDemandArea || "-";

      const score = Math.floor(Math.random()*20)+80;
      driverCard.innerHTML = `<b>Driver:</b> ${data.assignedDriver}<br>‚≠ê Rating: 4.8<br>üöó Vehicle: DL 01 AB 1234<br>AI Score: <b id="aiScore">${score}/100</b>`;

      aiBox.innerHTML = `ü§ñ AI Reasoning:<br>
      ‚Ä¢ Driver 1 distance: 2.1 km<br>
      ‚Ä¢ Driver 2 distance: 4.5 km<br>
      ‚Ä¢ Area demand: ${data.highDemandArea || "Normal"}<br>
      ‚Ä¢ Final decision: ${data.assignedDriver}`;

      if (data.highDemandArea === data.pickup) {
        surgeText.innerHTML = '<span class="surge">Surge Active üî∫</span>';
        showToast("High demand! Surge pricing applied");
      } else {
        surgeText.innerText = "No surge";
      }

      const eta = Math.floor(Math.random() * 4) + 2;
      etaText.innerText = eta;
      animateCar();

      totalRides++;
      totalFare += data.fare;
      totalRidesElem.innerText = totalRides;
      avgFareElem.innerText = Math.round(totalFare / totalRides);

      history.unshift(`${data.pickup} ‚Üí ${data.drop} | ‚Çπ${data.fare} | ${data.assignedDriver}`);
      history = history.slice(0,5);
      historyList.innerHTML = history.map(h => "‚Ä¢ " + h).join("<br>");

      confidenceFill.style.width = (Math.floor(Math.random()*20)+70) + "%";

      adminDemand.innerText = data.highDemandArea || "Normal";
      adminRides.innerText = totalRides;

      statusText.innerText = "Ride completed ‚úîÔ∏è";
      document.getElementById("notifySound").play();
      showToast("Driver found & ride booked!");
    } catch {
      offlineBanner.style.display = "block";
    }
  }

  async function loadHeatmap() {
    try {
      const res = await fetch("https://ai-mini-uber.onrender.com/heatmap");
      const data = await res.json();

      const points = data.heatmapData.map(loc => {
        if (loc === "A") return [28.6139, 77.2090, 0.8];
        if (loc === "B") return [28.6200, 77.2300, 0.8];
        if (loc === "C") return [28.6100, 77.2200, 0.8];
        if (loc === "D") return [28.6250, 77.2150, 0.8];
      });

      L.heatLayer(points, { radius: 25, blur: 15 }).addTo(map);
    } catch {
      offlineBanner.style.display = "block";
    }
  }
</script>

</body>
</html>

