<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Mini Uber â€“ Ultimate Edition</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    body { font-family:"Segoe UI", sans-serif; background:#f5f5f5; }
    body.dark { background:#0f172a; color:#e5e7eb; }

    .app { max-width:430px; margin:auto; background:white; min-height:100vh; display:flex; flex-direction:column; }
    body.dark .app { background:#1e293b; }

    .header { background:black; color:white; padding:14px; text-align:center; position:relative; }
    .header h2 { font-size:20px; }

    .top-btn {
      position:absolute; top:10px;
      padding:4px 10px; border-radius:20px;
      font-size:12px; cursor:pointer;
      background:white; color:black;
    }

    .demo-btn { left:10px; background:#bbf7d0; }
    .admin-btn { right:360px; background:#fde68a; }
    .voice-btn { right:320px; }
    .sos-btn { right:280px; background:#ef4444; color:white; }
    .profile-btn { right:240px; }
    .logout-btn { right:200px; background:#fecaca; }
    .toggle { right:160px; }

    #map { height:260px; width:100%; }

    .sheet {
      background:white; padding:14px;
      border-top-left-radius:20px;
      border-top-right-radius:20px;
      margin-top:-20px; flex:1; overflow-y:auto;
    }
    body.dark .sheet { background:#1e293b; }

    .card {
      background:#f3f4f6; padding:10px;
      border-radius:12px; margin-bottom:10px;
      font-size:13px;
    }
    body.dark .card { background:#334155; }

    .banner {
      background:#e0f2fe; color:#075985;
      padding:8px; border-radius:8px;
      margin-bottom:8px; font-size:13px;
    }

    .offline { background:#fee2e2; color:#991b1b; }

    .row { display:flex; justify-content:space-between; margin:4px 0; }

    .badge { background:#fee2e2; color:#991b1b; padding:2px 8px; border-radius:20px; font-size:12px; }
    .surge { background:#dc2626; color:white; padding:2px 8px; border-radius:20px; font-size:12px; }

    .bar { height:8px; background:#e5e7eb; border-radius:10px; overflow:hidden; margin-top:4px; }
    .fill { height:100%; background:#22c55e; width:0%; }

    button {
      width:100%; padding:10px;
      background:black; color:white;
      border:none; border-radius:8px;
      margin-top:6px; cursor:pointer;
    }

    .status { text-align:center; font-size:13px; margin-top:6px; color:#2563eb; }

    .admin-panel { background:#fef3c7; display:none; }

    .modal {
      position:fixed; top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.5);
      display:none; align-items:center; justify-content:center;
      z-index:10;
    }

    .modal-box { background:white; padding:20px; border-radius:12px; width:300px; }
    body.dark .modal-box { background:#1e293b; color:white; }

    .toast {
      position:fixed; bottom:20px; left:50%;
      transform:translateX(-50%);
      background:black; color:white;
      padding:10px 16px; border-radius:20px;
      font-size:13px; opacity:0; transition:0.3s;
    }
    .toast.show { opacity:1; }
  </style>
</head>

<body>

<script>
  if(localStorage.getItem("loggedIn") !== "true") {
    window.location.href = "login.html";
  }
</script>

<div class="app">

  <div class="header">
    <div class="top-btn demo-btn" onclick="demoMode()">Demo</div>
    <div class="top-btn admin-btn" onclick="toggleAdmin()">Admin</div>
    <div class="top-btn voice-btn" onclick="voiceBook()">ğŸ¤</div>
    <div class="top-btn sos-btn" onclick="sos()">SOS</div>
    <div class="top-btn profile-btn" onclick="openProfile()">ğŸ‘¤</div>
    <div class="top-btn logout-btn" onclick="logout()">â‹</div>
    <div class="top-btn toggle" onclick="toggleDark()">ğŸŒ™</div>
    <h2>AI Mini Uber</h2>
    <small id="welcomeUser"></small>
  </div>

  <div id="map"></div>

  <div class="sheet">

    <!-- Notifications -->
    <div class="card">
      <b>ğŸ”” Notifications</b>
      <div id="notificationBox">No new notifications</div>
    </div>

    <!-- AI Prediction -->
    <div class="banner" id="predictionBanner">ğŸ”® AI Prediction: High demand expected in Area B</div>
    <div class="banner offline" id="offlineBanner" style="display:none;">âš ï¸ You are offline. Showing cached data.</div>

    <!-- Traffic -->
    <div class="card">
      ğŸš¦ Traffic Status: <b id="trafficStatus">Moderate</b>
    </div>

    <!-- Stats -->
    <div class="card">
      ğŸŒ Network: 4G | Low Latency<br>
      Total Rides: <b id="totalRides">0</b> |
      Avg Fare: â‚¹ <b id="avgFare">0</b>
    </div>

    <!-- Pickup Drop -->
    <div class="card">
      <div class="row"><span>Pickup:</span><span id="pickupText">Tap on map</span></div>
      <div class="row"><span>Drop:</span><span id="dropText">Tap on map</span></div>
      <div class="row"><span>Distance:</span><span id="distanceText">â€“ km</span></div>
      <div class="row"><span>Fare:</span><span id="fareText">â‚¹ â€“</span></div>
      <div class="row"><span>High Demand:</span><span class="badge" id="demandText">â€“</span></div>
      <div class="row"><span>Surge:</span><span id="surgeText">â€“</span></div>
    </div>

    <!-- Route Options -->
    <div class="card">
      <b>ğŸ›£ Route Options</b><br>
      <button onclick="selectRoute('Fastest')">Fastest</button>
      <button onclick="selectRoute('Shortest')">Shortest</button>
      <button onclick="selectRoute('Scenic')">Scenic</button>
    </div>

    <!-- Saved Places -->
    <div class="card">
      <b>ğŸ“ Saved Places</b><br>
      <button onclick="setSaved('Home')">Home</button>
      <button onclick="setSaved('Office')">Office</button>
    </div>

    <!-- Saved Routes -->
    <div class="card">
      <b>ğŸ’¾ Saved Routes</b><br>
      <button onclick="saveRoute()">Save This Route</button>
      <div id="savedRoutesList"></div>
    </div>

    <!-- Schedule -->
    <div class="card">
      <b>â° Schedule Ride</b><br>
      <input type="datetime-local" id="scheduleTime" style="width:100%;padding:6px;">
    </div>

    <!-- Promo -->
    <div class="card">
      <b>ğŸ· Promo Code</b><br>
      <input id="promoCode" placeholder="Enter promo code" style="width:100%;padding:6px;">
      <button onclick="applyPromo()">Apply</button>
    </div>

    <!-- Wallet -->
    <div class="card">
      <b>ğŸ‘› Wallet</b><br>
      Balance: â‚¹<span id="walletBal">500</span><br>
      <button onclick="addMoney()">Add Money</button>
    </div>

    <!-- Green Ride -->
    <div class="card">
      <b>ğŸŒ± Green Ride</b><br>
      <button onclick="greenRide()">Enable EV Mode</button>
    </div>

    <!-- Driver Card -->
    <div class="card" id="driverCard">
      <b>Driver:</b> Rahul Sharma<br>
      â­ 4.9 | DL 01 AB 1234<br>
      AI Score: <b id="aiScore">â€“</b><br>
      <span style="color:blue;cursor:pointer" onclick="callDriver()">ğŸ“ Call Driver</span>
    </div>

    <!-- AI Reasoning -->
    <div class="card" id="aiBox">ğŸ¤– AI reasoning will appear here.</div>

    <!-- AI Timeline -->
    <div class="card">
      ğŸ¤– AI Timeline:
      <div id="timelineSteps">â€¢ Waiting for action...</div>
    </div>

    <!-- ETA -->
    <div class="card">ğŸš— Driver ETA: <b id="etaText">â€“</b> min</div>

    <!-- Confidence -->
    <div class="card">
      AI Confidence
      <div class="bar"><div class="fill" id="confidenceFill"></div></div>
    </div>

    <!-- Chat -->
    <div class="card">
      <b>ğŸ’¬ Chat with Driver</b><br>
      <input id="chatMsg" placeholder="Type message..." style="width:100%;padding:6px;">
      <button onclick="sendChat()">Send</button>
      <div id="chatBox"></div>
    </div>

    <!-- Safety -->
    <div class="card">
      <b>ğŸ›¡ Women Safety Mode</b><br>
      <button onclick="safetyMode()">Enable Safety Mode</button>
    </div>

    <!-- Emergency Contacts -->
    <div class="card">
      <b>ğŸ“ Emergency Contacts</b><br>
      <input id="emergencyContact" placeholder="Enter contact number" style="width:100%;padding:6px;">
      <button onclick="saveEmergency()">Save Contact</button>
    </div>

    <!-- Live Location Sharing -->
    <div class="card">
      <b>ğŸ“ Live Location Sharing</b><br>
      <button onclick="startSharing()">Start Sharing</button>
      <button onclick="stopSharing()">Stop Sharing</button>
    </div>

    <!-- Trip Progress -->
    <div class="card">
      <b>Trip Progress</b>
      <div class="bar"><div class="fill" id="tripProgress"></div></div>
    </div>

    <!-- Share -->
    <div class="card">
      <button onclick="shareTrip()">ğŸ“¤ Share Trip</button>
    </div>

    <!-- Ride History -->
    <div class="card">
      <b>Ride History</b>
      <div id="historyList">No rides yet</div>
    </div>

    <!-- Ride Replay -->
    <div class="card">
      <b>â–¶ï¸ Ride Replay</b><br>
      <button onclick="replayRide()">Replay Last Ride</button>
    </div>

    <!-- Admin Panel -->
    <div class="card admin-panel" id="adminPanel">
      <b>ğŸ›  Admin Panel</b><br>
      Active Drivers: 3<br>
      High Demand Zone: <span id="adminDemand">â€“</span><br>
      Total Rides Today: <span id="adminRides">0</span><br>
      Driver Earnings Today: â‚¹<span id="driverEarnings">1200</span>
    </div>

    <button onclick="bookRide()">Book Ride</button>
    <div class="status" id="statusText"></div>

  </div>

</div>

<!-- Payment Modal -->
<div class="modal" id="paymentModal">
  <div class="modal-box">
    <h3>ğŸ’³ Choose Payment</h3>
    <button onclick="pay('Cash')">Cash</button>
    <button onclick="pay('UPI')">UPI</button>
    <button onclick="pay('Card')">Card</button>
  </div>
</div>

<!-- Rating Modal -->
<div class="modal" id="ratingModal">
  <div class="modal-box">
    <h3>â­ Rate Your Ride</h3>
    <button onclick="rate(5)">â˜…â˜…â˜…â˜…â˜…</button>
    <button onclick="rate(4)">â˜…â˜…â˜…â˜…â˜†</button>
    <button onclick="rate(3)">â˜…â˜…â˜…â˜†â˜†</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  let map, pickupLatLng, dropLatLng, pickupMarker, dropMarker, carMarker;
  let walletBalance = 500;
  let promoDiscount = 0;
  let totalRides = 0, totalFare = 0;
  let history = [];
  let savedRoutes = [];
  let adminOn = false;

  welcomeUser.innerText = "Welcome, " + localStorage.getItem("username");

  function toggleDark(){ document.body.classList.toggle("dark"); }

  function toggleAdmin(){
    adminOn = !adminOn;
    adminPanel.style.display = adminOn ? "block" : "none";
  }

  function logout(){ localStorage.clear(); window.location.href="login.html"; }
  function openProfile(){ alert("User: "+localStorage.getItem("username")); }
  function voiceBook(){ alert("ğŸ¤ Voice booking activated (demo)"); }
  function sos(){ alert("ğŸš¨ SOS Activated! Emergency contacts notified."); }
  function safetyMode(){ alert("ğŸ›¡ Safety mode enabled"); }
  function callDriver(){ alert("ğŸ“ Calling driver..."); }
  function shareTrip(){ alert("ğŸ“¤ Trip shared"); }
  function demoMode(){ alert("Demo mode on"); }

  function notify(msg){
    notificationBox.innerText = msg;
    showToast(msg);
  }

  function showToast(msg){
    const t = document.getElementById("toast");
    t.innerText = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"),2000);
  }

  function updateTraffic(){
    const states = ["Low", "Moderate", "High"];
    trafficStatus.innerText = states[Math.floor(Math.random()*states.length)];
  }
  setInterval(updateTraffic,4000);

  function selectRoute(type){ showToast(type+" route selected"); }

  function setSaved(place){ alert(place+" selected"); }

  function saveRoute(){
    if(pickupLatLng && dropLatLng){
      savedRoutes.push(pickupText.innerText+" â†’ "+dropText.innerText);
      savedRoutesList.innerHTML = savedRoutes.map(r=>"â€¢ "+r).join("<br>");
      showToast("Route saved");
    }
  }

  function applyPromo(){
    if(promoCode.value==="AI50"){ promoDiscount=50; alert("â‚¹50 discount applied"); }
    else alert("Invalid code");
  }

  function addMoney(){
    walletBalance+=100;
    walletBal.innerText = walletBalance;
    showToast("â‚¹100 added to wallet");
  }

  function greenRide(){ showToast("EV ride selected â€“ eco friendly ğŸŒ"); }

  function sendChat(){
    if(chatMsg.value==="") return;
    chatBox.innerHTML += "You: "+chatMsg.value+"<br>";
    chatMsg.value="";
    setTimeout(()=> chatBox.innerHTML+="Driver: On my way ğŸš—<br>",800);
  }

  function saveEmergency(){
    const num = emergencyContact.value;
    if(num){
      localStorage.setItem("emergencyContact",num);
      showToast("Emergency contact saved");
    }
  }

  function startSharing(){ showToast("Live location sharing ON"); }
  function stopSharing(){ showToast("Live location sharing OFF"); }

  function replayRide(){
    showToast("Replaying last ride (demo)");
    animateCar();
  }

  function initMap(){
    map = L.map("map").setView([28.6139,77.2090],13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

    map.on("click",function(e){
      if(!pickupLatLng){
        pickupLatLng = e.latlng;
        pickupMarker = L.marker(pickupLatLng).addTo(map).bindPopup("Pickup").openPopup();
        pickupText.innerText = pickupLatLng.lat.toFixed(3)+", "+pickupLatLng.lng.toFixed(3);
      } else if(!dropLatLng){
        dropLatLng = e.latlng;
        dropMarker = L.marker(dropLatLng).addTo(map).bindPopup("Drop").openPopup();
        dropText.innerText = dropLatLng.lat.toFixed(3)+", "+dropLatLng.lng.toFixed(3);
        L.polyline([pickupLatLng,dropLatLng],{color:"blue"}).addTo(map);
        carMarker = L.marker(pickupLatLng).addTo(map).bindPopup("Driver");
      }
    });
  }
  initMap();

  function bookRide(){
    const schedule = scheduleTime.value;
    if(schedule){
      alert("Ride scheduled for: "+schedule);
      return;
    }
    if(!pickupLatLng || !dropLatLng){ alert("Select pickup & drop"); return; }
    paymentModal.style.display="flex";
  }

  function pay(method){
    paymentModal.style.display="none";
    showToast("Paid via "+method);
    startRide();
  }

  function startRide(){
    statusText.innerText="Ride started...";
    notify("Driver assigned & on the way ğŸš—");

    timelineSteps.innerHTML="â€¢ Analyzing demand...";
    setTimeout(()=>timelineSteps.innerHTML+="<br>â€¢ Selecting driver...",800);
    setTimeout(()=>timelineSteps.innerHTML+="<br>â€¢ Optimizing route...",1600);
    setTimeout(()=>timelineSteps.innerHTML+="<br>â€¢ Ride started âœ…",2400);

    aiBox.innerHTML="ğŸ¤– AI Reasoning:<br>â€¢ High demand area<br>â€¢ Closest driver selected<br>â€¢ Optimal pricing applied";

    demandText.innerText="High";
    surgeText.innerHTML='<span class="surge">Surge Active ğŸ”º</span>';

    const dist = (Math.random()*5+1).toFixed(2);
    let fare = Math.floor(Math.random()*100)+100 - promoDiscount;
    distanceText.innerText = dist+" km";
    fareText.innerText = "â‚¹ "+fare;

    etaText.innerText = Math.floor(Math.random()*5)+2;
    confidenceFill.style.width = (Math.floor(Math.random()*20)+70)+"%";

    let progress=0;
    const intv = setInterval(()=>{
      progress+=10;
      tripProgress.style.width = progress+"%";
      if(progress>=100){
        clearInterval(intv);
        statusText.innerText="Ride completed âœ”ï¸";
        ratingModal.style.display="flex";
      }
    },1000);

    animateCar();

    totalRides++;
    totalFare+=fare;
    totalRidesElem.innerText = totalRides;
    avgFareElem.innerText = Math.round(totalFare/totalRides);

    history.unshift("â‚¹"+fare+" | "+dist+" km | Rahul Sharma");
    history = history.slice(0,5);
    historyList.innerHTML = history.map(h=>"â€¢ "+h).join("<br>");

    adminDemand.innerText="High";
    adminRides.innerText=totalRides;
    driverEarnings.innerText = parseInt(driverEarnings.innerText) + fare;
  }

  function animateCar(){
    let i=0;
    const steps=20;
    const latStep = (dropLatLng.lat - pickupLatLng.lat)/steps;
    const lngStep = (dropLatLng.lng - pickupLatLng.lng)/steps;

    const interval = setInterval(()=>{
      if(i>=steps){ clearInterval(interval); return; }
      carMarker.setLatLng([
        pickupLatLng.lat + latStep*i,
        pickupLatLng.lng + lngStep*i
      ]);
      i++;
    },500);
  }

  function rate(stars){
    ratingModal.style.display="none";
    showToast("Thanks for rating "+stars+"â­");
  }
</script>

</body>
</html>
